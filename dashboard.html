<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recycling Analytics Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    :root {
        --primary-color: #21e31a;
        --secondary-color: #3f37c9;
        --accent-color: #4895ef;
        --dark-color: #1e1e2c;
        --light-color: #f8f9fa;
        --success-color: #4cc9f0;
        --warning-color: #f72585;
        --eco-green: #2ecc71;
        --eco-blue: #3498db;
        --eco-teal: #1abc9c;
        --eco-purple: #9b59b6;
        --gray-color: #6c757d;
        --transition: all 0.3s ease;
    }

    body {
        background-color: #f5f7fb;
        color: #333;
        display: flex;
        min-height: 100vh;
    }

    /* Sidebar Styles */
    .sidebar {
        width: 260px;
        background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
        color: white;
        height: 100vh;
        position: fixed;
        padding: 20px 0;
        display: flex;
        flex-direction: column;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        transition: var(--transition);
        z-index: 1000;
    }

    .sidebar-header {
        padding: 0 20px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
    }

    .sidebar-header h2 {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
    }

    .sidebar-header h2 i {
        color: var(--accent-color);
        background: white;
        padding: 10px;
        border-radius: 10px;
    }

    .sidebar-menu {
        flex: 1;
    }

    .menu-item {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        margin: 5px 0;
        cursor: pointer;
        transition: var(--transition);
        border-left: 4px solid transparent;
    }

    .menu-item:hover {
        background: rgba(255, 255, 255, 0.1);
        border-left: 4px solid var(--accent-color);
    }

    .menu-item.active {
        background: rgba(255, 255, 255, 0.15);
        border-left: 4px solid var(--accent-color);
    }

    .menu-item i {
        margin-right: 15px;
        font-size: 18px;
    }

    .menu-item span {
        font-size: 16px;
    }

    .sidebar-footer {
        padding: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logout-btn {
        width: 100%;
        border: none;
        display: flex;
        align-items: center;
        color: white;
        background: rgba(255, 255, 255, 0.1);
        padding: 15px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
    }

    .logout-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .logout-btn i {
        margin-right: 15px;
        font-size: 18px;
    }

    /* Main Content Styles */
    .main-content {
        flex: 1;
        margin-left: 260px;
        padding: 30px;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .welcome-message h1 {
        font-size: 28px;
        color: var(--dark-color);
        margin-bottom: 5px;
    }

    .welcome-message p {
        color: var(--gray-color);
    }

    .search-bar {
        display: flex;
        align-items: center;
        background: white;
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .search-bar input {
        border: none;
        outline: none;
        padding: 8px 15px;
        font-size: 16px;
        width: 250px;
    }

    .search-bar i {
        color: var(--gray-color);
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .user-info {
        text-align: right;
    }

    .user-info h4 {
        font-weight: 600;
    }

    .user-info p {
        font-size: 14px;
        color: var(--gray-color);
    }

    .avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 20px;
    }

    /* Page Title */
    .page-title {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .page-title i {
        background: var(--eco-green);
        color: white;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        margin-right: 15px;
        font-size: 22px;
    }

    .page-title h2 {
        font-size: 24px;
        color: var(--dark-color);
    }

    /* Stats Cards */
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: var(--transition);
        display: flex;
        align-items: center;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .stat-icon {
        width: 70px;
        height: 70px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        margin-right: 20px;
    }

    .stat-info h3 {
        font-size: 28px;
        margin-bottom: 5px;
        color: var(--dark-color);
    }

    .stat-info p {
        color: var(--gray-color);
    }

    /* Charts Section */
    .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--dark-color);
    }

    .chart-actions select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
    }

    .chart-canvas {
        position: relative;
        height: 300px;
        width: 100%;
    }

    /* Debug Section */
    .debug-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
    }

    .debug-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .debug-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--dark-color);
    }

    .debug-content {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 14px;
    }

    .debug-toggle {
        background: var(--eco-blue);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
    }

    /* Status Cards */
    .status-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .status-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        text-align: center;
    }

    .status-count {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .status-label {
        color: var(--gray-color);
        font-size: 14px;
    }

    /* Loading Indicator */
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid var(--primary-color);
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--gray-color);
    }

    .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        color: #ddd;
    }

    .empty-state h3 {
        font-size: 24px;
        margin-bottom: 10px;
        color: var(--dark-color);
    }

    .empty-state p {
        margin-bottom: 20px;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }

    .empty-state .btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
    }

    .empty-state .btn:hover {
        background: var(--secondary-color);
    }

    /* Demo Mode Banner */
    .demo-banner {
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .demo-banner .demo-text {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .demo-banner .demo-close {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 18px;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .charts-container {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 992px) {
        .sidebar {
            width: 80px;
        }
        
        .sidebar-header h2 span,
        .menu-item span {
            display: none;
        }
        
        .menu-item {
            justify-content: center;
            padding: 15px;
        }
        
        .menu-item i {
            margin-right: 0;
        }
        
        .logout-btn span {
            display: none;
        }
        
        .logout-btn {
            justify-content: center;
        }
        
        .main-content {
            margin-left: 80px;
        }
    }

    @media (max-width: 768px) {
        .header {
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
        }
        
        .search-bar {
            width: 100%;
        }
        
        .search-bar input {
            width: 100%;
        }
        
        .stats-cards {
            grid-template-columns: 1fr;
        }
        
        .status-cards {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .stat-card {
            flex-direction: column;
            text-align: center;
        }
        
        .stat-icon {
            margin-right: 0;
            margin-bottom: 15px;
        }
        
        .demo-banner {
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>
        <svg style="width:34px;" class="h-8 w-8 text-primary-600 transform transition-transform hover:rotate-12 duration-300"
          viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 4L3 8L12 12L21 8L12 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round"></path>
          <path d="M3 16L12 20L21 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round"></path>
          <path d="M3 12L12 16L21 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg> <span>Trash2Tech</span>
      </h2>
    </div>

    <div class="sidebar-menu">
      <a style="text-decoration:none;color:white;" href="homenew.html">
        <div class="menu-item">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </div>
      </a>
      <a style="text-decoration:none;color:white;" href="dashboard.html">
        <div class="menu-item active">
          <i class="fa-solid fa-compass"></i>
          <span>Dashboard</span>
        </div>
      </a>
      <a style="text-decoration:none;color:white;" href="assets.html">
        <div class="menu-item">
          <i class="fas fa-briefcase"></i>
          <span>Assets</span>
        </div>
      </a>
    </div>

    <div class="sidebar-footer">
      <div>
        <button class="logout-btn" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <div class="welcome-message">
        <h1>Dashboard</h1>
        <p>Track your organization's sustainability impact</p>
      </div>

      <div class="user-profile">
        <div class="user-info">
          <h4 id="loggedInUserName">Loading...</h4>
          <p>User</p>
        </div>
        <div class="avatar" id="userAvatar">?</div>
      </div>
    </div>

    <div id="demoBanner" class="demo-banner" style="display: none;">
      <div class="demo-text">
        <i class="fas fa-info-circle"></i>
        <span>You're viewing demo data. Add recycling items to see your real impact.</span>
      </div>
      <button class="demo-close" id="closeDemoBanner">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="page-title">
      <i class="fas fa-leaf"></i>
      <h2>Environmental Impacts</h2>
    </div>

    <!-- Debug Section -->
    

    <!-- Stats Cards -->
    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-icon" style="background: rgba(46, 204, 113, 0.1); color: var(--eco-green);">
          <i class="fas fa-cloud"></i>
        </div>
        <div class="stat-info">
          <h3 id="co2Saved">0t</h3>
          <p>CO₂ Emissions Saved</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: rgba(52, 152, 219, 0.1); color: var(--eco-blue);">
          <i class="fas fa-weight-hanging"></i>
        </div>
        <div class="stat-info">
          <h3 id="ewasteRecycled">0kg</h3>
          <p>E-Waste Recycled</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background: rgba(155, 89, 182, 0.1); color: var(--eco-purple);">
          <i class="fas fa-recycle"></i>
        </div>
        <div class="stat-info">
          <h3 id="totalDevices">0</h3>
          <p>Total Devices Recycled</p>
        </div>
      </div>
    </div>

    <!-- Status Cards -->
    <div class="status-cards">
      <div class="status-card">
        <div class="status-count" id="pendingCount">0</div>
        <div class="status-label">Pending Requests</div>
      </div>
      <div class="status-card">
        <div class="status-count" id="processedCount">0</div>
        <div class="status-label">Processed Requests</div>
      </div>
      <div class="status-card">
        <div class="status-count" id="resellCount">0</div>
        <div class="status-label">To Be Resold</div>
      </div>
      <div class="status-card">
        <div class="status-count" id="recycleCount">0</div>
        <div class="status-label">To Be Recycled</div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Devices by Type</div>
          <div class="chart-actions">
            <select id="chartTypeSelector">
              <option value="count">By Count</option>
              <option value="weight">By Weight</option>
            </select>
          </div>
        </div>
        <div class="chart-canvas">
          <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
          </div>
          <div id="emptyDevicesState" class="empty-state" style="display: none;">
            <i class="fas fa-chart-bar"></i>
            <h3>No Device Data</h3>
            <p>You haven't added any devices yet. Start recycling to see your impact visualized.</p>
            <button class="btn" onclick="location.href='assets.html'">Add Devices</button>
          </div>
          <canvas id="devicesChart"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Devices by Condition</div>
        </div>
        <div class="chart-canvas">
          <div id="emptyConditionState" class="empty-state" style="display: none;">
            <i class="fas fa-chart-pie"></i>
            <h3>No Condition Data</h3>
            <p>Device condition data will appear here once you add recycling items.</p>
            <button class="btn" onclick="location.href='assets.html'">Add Devices</button>
          </div>
          <canvas id="conditionChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyCqTgVdqJsP4h5Dq-iqex5Eooe3TsRYLPw",
      authDomain: "e-waste-149d2.firebaseapp.com",
      projectId: "e-waste-149d2",
      databaseURL: "https://e-waste-149d2-default-rtdb.firebaseio.com",
      storageBucket: "e-waste-149d2.firebasestorage.app",
      messagingSenderId: "673162803344",
      appId: "1:673162803344:web:31f6190298e301b8ca4015",
      measurementId: "G-V6VFSC3NJE"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Global variables
    let devicesChart = null;
    let conditionChart = null;
    let recyclingData = null;
    let isDemoMode = false;

    // Device type weights (kg) for CO2 calculations
    const deviceWeights = {
      'laptop': 2.5,
      'monitor': 7.0,
      'desktop': 8.0,
      'tablet': 0.6,
      'phone': 0.2,
      'printer': 10.0,
      'server': 25.0,
      'other': 5.0
    };

    // CO2 savings per kg of e-waste recycled (kg CO2)
    const CO2_SAVINGS_PER_KG = 1.8;

    // Auth check
    function checkAuthState() {
      auth.onAuthStateChanged(user => {
        if (user) {
          document.getElementById('loggedInUserName').textContent =
            user.displayName || user.email;
          document.getElementById('userAvatar').textContent =
            user.displayName ? user.displayName.charAt(0).toUpperCase()
              : user.email.charAt(0).toUpperCase();
          
          // Load data from Firebase after authentication
          loadRecyclingData();
        } else {
          // not logged in → go to login/home
          window.location.href = 'homenew.html';
        }
      });
    }
    checkAuthState();

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', function () {
      auth.signOut().then(() => {
        window.location.href = 'homenew.html';
      }).catch(error => {
        console.error('Logout error:', error);
        alert("Error logging out");
      });
    });

    

    // Close demo banner
    document.getElementById('closeDemoBanner').addEventListener('click', function() {
      document.getElementById('demoBanner').style.display = 'none';
    });

    // Generate sample data for demo purposes
    function generateSampleData() {
      const sampleData = {};
      const deviceTypes = ['laptop', 'monitor', 'phone', 'tablet', 'desktop'];
      const conditions = ['excellent', 'good', 'fair', 'poor'];
      const statuses = ['pending', 'processed'];
      const dispositions = ['resell', 'recycle'];
      
      // Generate 5-10 sample devices
      const deviceCount = Math.floor(Math.random() * 6) + 5;
      
      for (let i = 0; i < deviceCount; i++) {
        const deviceId = 'sample_' + Date.now() + '_' + i;
        const deviceType = deviceTypes[Math.floor(Math.random() * deviceTypes.length)];
        const condition = conditions[Math.floor(Math.random() * conditions.length)];
        const status = statuses[Math.floor(Math.random() * statuses.length)];
        const disposition = dispositions[Math.floor(Math.random() * dispositions.length)];
        
        sampleData[deviceId] = {
          deviceInfo: {
            type: deviceType,
            condition: condition,
            brand: 'Sample Brand',
            model: 'Sample Model'
          },
          status: status,
          recyclingDetails: {
            disposition: disposition,
            date: new Date().toISOString()
          }
        };
      }
      
      return sampleData;
    }

    // Load recycling data from Firebase
    function loadRecyclingData() {
      const userId = auth.currentUser.uid;
      // Try multiple possible database paths
      const possiblePaths = [
        'recyclingData/' + userId,
        'users/' + userId + '/recyclingData',
        'recyclingData'
      ];
      
      // Show loading indicator
      document.getElementById('loadingIndicator').style.display = 'flex';
      document.getElementById('devicesChart').style.display = 'none';
      document.getElementById('emptyDevicesState').style.display = 'none';
      document.getElementById('emptyConditionState').style.display = 'none';
      document.getElementById('debugOutput').textContent = "Loading data from Firebase...";
      
      // Try each path until we find data
      tryPaths(possiblePaths, 0);
    }

    function tryPaths(paths, index) {
      if (index >= paths.length) {
        // No data found in any path - use sample data for demo
        document.getElementById('debugOutput').textContent = 
          "Tried paths: " + paths.join(", ") + "\nNo data found in any path. Using demo data.";
        
        // Generate and use sample data
        recyclingData = generateSampleData();
        isDemoMode = true;
        document.getElementById('demoBanner').style.display = 'flex';
        
        // Process data and update all visualizations
        processRecyclingData(recyclingData);
        
        // Initialize charts
        initDevicesChart('count');
        initConditionChart();
        
        // Hide loading indicator and show chart
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('devicesChart').style.display = 'block';
        return;
      }
      
      const path = paths[index];
      const recyclingRef = database.ref(path);
      
      document.getElementById('debugOutput').textContent = 
        "Trying path: " + path + "\nLoading...";
      
      recyclingRef.once('value')
        .then(snapshot => {
          recyclingData = snapshot.val();
          
          if (recyclingData) {
            document.getElementById('debugOutput').textContent = 
              "Data found at path: " + path + "\n" +
              "Data structure:\n" + JSON.stringify(recyclingData, null, 2);
            
            isDemoMode = false;
            document.getElementById('demoBanner').style.display = 'none';
            
            // Process data and update all visualizations
            processRecyclingData(recyclingData);
            
            // Initialize charts
            initDevicesChart('count');
            initConditionChart();
            
            // Hide loading indicator and show chart
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('devicesChart').style.display = 'block';
          } else {
            // Try next path
            document.getElementById('debugOutput').textContent = 
              "No data at path: " + path + "\nTrying next path...";
            tryPaths(paths, index + 1);
          }
        })
        .catch(error => {
          console.error('Error loading recycling data:', error);
          document.getElementById('debugOutput').textContent = 
            "Error loading from path: " + path + "\n" + error.message + "\nTrying next path...";
          tryPaths(paths, index + 1);
        });
    }

    // Process recycling data to extract statistics
    function processRecyclingData(data) {
      let totalCO2 = 0;
      let totalWeight = 0;
      let totalDevices = 0;
      let pendingCount = 0;
      let processedCount = 0;
      let resellCount = 0;
      let recycleCount = 0;
      
      const deviceCounts = {};
      const deviceWeightsData = {};
      const conditionCounts = {};
      
      // Initialize device types
      Object.keys(deviceWeights).forEach(type => {
        deviceCounts[type] = 0;
        deviceWeightsData[type] = 0;
      });
      
      // Initialize condition counts
      conditionCounts['excellent'] = 0;
      conditionCounts['good'] = 0;
      conditionCounts['fair'] = 0;
      conditionCounts['poor'] = 0;
      conditionCounts['broken'] = 0;
      conditionCounts['unknown'] = 0;
      
      // Check if data is in the expected format (object with device entries)
      if (data && typeof data === 'object') {
        Object.values(data).forEach(device => {
          // Handle different possible data structures
          const deviceInfo = device.deviceInfo || device;
          
          if (deviceInfo && typeof deviceInfo === 'object') {
            const type = (deviceInfo.type || 'other').toLowerCase();
            const condition = (deviceInfo.condition || 'unknown').toLowerCase();
            const status = device.status || 'pending';
            const disposition = (device.recyclingDetails && device.recyclingDetails.disposition) || 'unknown';
            
            // Count devices by type
            deviceCounts[type] = (deviceCounts[type] || 0) + 1;
            
            // Calculate weight by type
            const weight = deviceWeights[type] || deviceWeights.other;
            deviceWeightsData[type] = (deviceWeightsData[type] || 0) + weight;
            
            // Count conditions
            conditionCounts[condition] = (conditionCounts[condition] || 0) + 1;
            
            // Update totals
            totalWeight += weight;
            totalDevices++;
            
            // Count statuses
            if (status === 'pending') pendingCount++;
            else processedCount++;
            
            // Count dispositions
            if (disposition === 'resell') resellCount++;
            else if (disposition === 'recycle') recycleCount++;
          }
        });
      }
      
      // Calculate CO2 savings
      totalCO2 = totalWeight * CO2_SAVINGS_PER_KG;
      
      // Update stats cards
      document.getElementById('co2Saved').textContent = (totalCO2 / 1000).toFixed(1) + 't';
      document.getElementById('ewasteRecycled').textContent = totalWeight.toFixed(1) + 'kg';
      document.getElementById('totalDevices').textContent = totalDevices;
      
      // Update status cards
      document.getElementById('pendingCount').textContent = pendingCount;
      document.getElementById('processedCount').textContent = processedCount;
      document.getElementById('resellCount').textContent = resellCount;
      document.getElementById('recycleCount').textContent = recycleCount;
      
      // Store processed data for charts
      window.processedData = {
        deviceCounts,
        deviceWeightsData,
        conditionCounts,
        hasData: totalDevices > 0
      };
    }

    // Initialize devices chart based on selected view
    function initDevicesChart(viewType) {
      const devicesCtx = document.getElementById('devicesChart').getContext('2d');
      
      if (!window.processedData) return;
      
      const { deviceCounts, deviceWeightsData, hasData } = window.processedData;
      
      // Show empty state if no data
      if (!hasData) {
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('emptyDevicesState').style.display = 'block';
        return;
      }
      
      // Prepare data based on view type
      const labels = [];
      const dataValues = [];
      const backgroundColors = [
        'rgba(52, 152, 219, 0.7)',
        'rgba(46, 204, 113, 0.7)',
        'rgba(155, 89, 182, 0.7)',
        'rgba(241, 196, 15, 0.7)',
        'rgba(230, 126, 34, 0.7)',
        'rgba(26, 188, 156, 0.7)',
        'rgba(149, 165, 166, 0.7)',
        'rgba(231, 76, 60, 0.7)'
      ];
      
      // Determine data field based on view type
      let dataSource, labelText;
      if (viewType === 'weight') {
        dataSource = deviceWeightsData;
        labelText = 'Weight (kg)';
      } else {
        dataSource = deviceCounts;
        labelText = 'Number of Devices';
      }
      
      // Extract data
      Object.entries(dataSource).forEach(([deviceType, count], index) => {
        if (count > 0) {
          labels.push(deviceType.charAt(0).toUpperCase() + deviceType.slice(1));
          dataValues.push(count);
        }
      });
      
      // Destroy existing chart if it exists
      if (devicesChart) {
        devicesChart.destroy();
      }
      
      // Create new chart
      devicesChart = new Chart(devicesCtx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: labelText,
            data: dataValues,
            backgroundColor: backgroundColors.slice(0, labels.length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.raw}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: labelText }
            }
          }
        }
      });
    }

    // Initialize condition chart
    function initConditionChart() {
      const conditionCtx = document.getElementById('conditionChart').getContext('2d');
      
      if (!window.processedData) return;
      
      const { conditionCounts, hasData } = window.processedData;
      
      // Show empty state if no data
      if (!hasData) {
        document.getElementById('emptyConditionState').style.display = 'block';
        return;
      }
      
      // Prepare data
      const labels = [];
      const dataValues = [];
      const backgroundColors = [
        'rgba(46, 204, 113, 0.7)', // Excellent - green
        'rgba(52, 152, 219, 0.7)', // Good - blue
        'rgba(241, 196, 15, 0.7)', // Fair - yellow
        'rgba(230, 126, 34, 0.7)', // Poor - orange
        'rgba(231, 76, 60, 0.7)',  // Broken - red
        'rgba(149, 165, 166, 0.7)' // Unknown - gray
      ];
      
      // Extract data
      Object.entries(conditionCounts).forEach(([condition, count], index) => {
        if (count > 0) {
          labels.push(condition.charAt(0).toUpperCase() + condition.slice(1));
          dataValues.push(count);
        }
      });
      
      // Destroy existing chart if it exists
      if (conditionChart) {
        conditionChart.destroy();
      }
      
      // Create new chart
      conditionChart = new Chart(conditionCtx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: dataValues,
            backgroundColor: backgroundColors.slice(0, labels.length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // Event listener for chart type selector
    document.getElementById('chartTypeSelector').addEventListener('change', function() {
      initDevicesChart(this.value);
    });

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Chart initialization will happen after data is loaded from Firebase
    });
  </script>
</body>
</html>